# 헤더에서 처리하는 JWT
그동안 JWT를 써오면서 로그인 시 응답의 바디값에 access와 refresh 토큰을 반환해주고, refresh 토큰을 별도로 갱신해주는 API도 따로 만들었었다.  
이번에 새롭게 개발을 진행하면서 같이 작업하던 분이 바디가 아닌 헤더로 리프레시 토큰을 이용해 토큰 재갱신을 해주는 방식으로 개발을 진행했다.  
토큰 발급이나 토큰 재갱신이나 아무 생각없이 API를 통해서 바디값에 담아서 전달해주었는데, 저 개발 내용을 보고 나니 토큰을 어떻게 처리하는게 맞는건지 알고싶어졌다.  
그래서 해당 내용에 대해 정리를 해보려 한다.  

## JWT
JWT는 이전에 한번 정리를 한 적이 있어서, 간단하게 핵심만 다시 짚어보고 넘어가려 한다.

* JSON 을 이용하여 토큰 자체에 사용자 인증 정보를 저장하는 웹 토큰방식
* 서명을 이용하여 인증을 확인함.
* 인증 권한을 부여하거나, 정보 교환 시에 많이 사용함.

JWT는 위와 같은 특징들을 지닌다.  

## 토큰을 제공하는 방식?
그렇다면 위 개발 내용처럼 헤더에 보내주는 것이 맞을까? 아니면 바디에 값을 담아 전달해주는 것이 맞을까?  
몇몇 케이스를 찾아보며 내린 결론은 둘 다 상관없다는 것이다. 나름대로 생각해본 이유는 아래와 같다.

### 서버에서 헤더값으로 제공하는 경우?
헤더에 담을 경우 장점은 보안성이 높아진다는 것이다. 토큰 발급이나 토큰 재갱신을 위한 API 호출 시 바디에 담아 전달할 경우,  
바디값에 토큰정보가 그대로 노출되게 된다. 헤더에 토큰을 담으면 API를 호출하더라도 바디값에 노출되지 않기 때문에, 보안성이 조금이나마 올라간다고 생각된다. 
토큰안에 중요한 정보들이 들어가있지 않다고 하여도 보안적으로 취약할 수 있으니 숨길 수 있다면 숨기는게 좋다고 본다.  
또 하나는 백엔드 단에서 별도의 토큰 재갱신 API를 만들 필요가 필요 없다는 것이다.   
바디 값으로 제공해주기 위해선 토큰을 재갱신하는 API가 별도로 필요하다. 클라이언트 단에서는 API 호출시 401 응답을 받게 되면 리프레시 토큰을 이용하여 재갱신 API 를 호출해주고, 
재갱신 해준 토큰을 응답값으로 받아와 다시 토큰 세팅을 하여 호출하려던 API를 호출해주어야 한다.   
반면, 헤더만 이용하여 토큰 재갱신을 해줄 경우 클라이언트는 API 호출 후 401 응답이 왔을 경우 별도 재갱신 API 를 호출하지 않고 
단순히 리프레시 토큰만 함께 담아 API를 다시 호출해주면 된다. 그럼 서버단에서는 리프레시 토큰 유무를 판단하여 리프레시 토큰이 만료되지 않았으면 
새로운 토큰과 리프레시 토큰을 헤더로 보내주고, 둘다 만료됐을 경우 다시 401 응답을 줘 재로그인을 하도록 처리해준다.  
클라이언트도 단순하게 리프레시 토큰만 같이 담아 원래 호출하려던 API 호출을 해주면 되는 것이므로 별도 API를 호출해야하는 번거로운 작업이 조금은 줄어든다. 


### 서버에서 바디값으로 제공하는 경우?
서버에서 바디값으로 토큰을 제공하여 처리하는 경우는 아무래도 API 호출 시 별도 설정이 필요없다는 것이다.  
헤더에 넣어 제공할 경우, 서버쪽에서는 작업을 하나 해주어야 한다. 바로 Access-Control-Expose-Headers 설정을 해주는 것이다.  
Access-Control-Expose-Headers 헤더는 브라우저의 자바스크립트가 액세스할 수 있는 헤더들을 나타낸다. 기본적으로 CORS 허용 목록에 포함된 응답 헤더만 노출된다.
만약 다른 헤더에 접근하고 싶다면, 서버에서 해당 헤더를 접근할 수 있도록 설정을 추가해주어야 한다. 즉 응답 헤더에 토큰과 리프레시 토큰이 담긴 헤더에 접근할 수 있도록
서버가 설정을 변경해주어야 하는 것이다. 만일 서버에서 보안상의 이유로 헤더를 숨겨야 한다면, 바디값으로 토큰 정보들을 제공하는 것이 가장 알맞은 방법일 것이다.  


## 결론
JWT 의 재갱신을 어떻게 처리하는게 좋을지에 대해 각각의 방법으로 알아보았다. 개인적으로는 첫 로그인시 토큰 발급은 Body를 통해 발급해주고, 재갱신과 같은 처리는
헤더값을 통해 처리하는게 더 괜찮은 방법이라고 생각이 들었다. 서버단에서 엑세스토큰 만료와 리프레시 토큰 만료까지만 잘 구분하여 전달해준다면 서버측도 별도의 재갱신 API가 필요없고,
클라이언트 역시 단순하게 토큰 만료시 리프레시 토큰만 추가하여 더 호출하면 되기 때문이다.  
하지만 가장 중요한 것은 쓰는 방법에는 정답이 없단 것이다. 자신이 쓰기 더 편한 방식 혹은 같이 일하는 사람과 맞춰갈 수 있는 방식이 가장 베스트한 방식이라고 생각한다.


## 출처
https://velog.io/@hiy7030/Spring-Security-JWT-Token
https://velog.io/@kwontae1313/JSON-Web-Token%EC%9D%80-%EC%99%9C-%ED%97%A4%EB%8D%94%EB%A1%9C-%EC%A3%BC%EA%B3%A0%EB%B0%9B%EC%9D%84%EA%B9%8C
https://velog.io/@rhqjatn2398/Access-Control-Expose-Headers-CORS-safelisted-response-header
https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
https://fetch.spec.whatwg.org/#cors-safelisted-response-header
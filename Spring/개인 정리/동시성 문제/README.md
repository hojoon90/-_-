# 동시성 문제

프로젝트 진행 중 사용자의 관심 설정 처리와 관련하여 동시성 처리 문제가 발생하였다. 그래서 이왕 하는 김에 해당 문제가 왜 생겼고 어떻게 처리 했는지,
동시성 문제와 처리 방법들에 대해 기록으로 남겨보려고 한다.

## 발생 현상 및 해결 방법
먼저 현재 진행중인 프로젝트는 관심 설정에 대해 아래와 같은 조건을 전제로 한다.
* 사용자가 여러 기기에서 같은 아이디로 서비스를 이용할 수 있다.
* DB 테이블에 관심 데이터는 한 사용자당 동일한 데이터가 2개이상 쌓이면 안된다.
  * 없으면 insert, 있으면 관심여부 값만 update 해준다.

사용자는 여러 기기에서 같은 아이디를 사용할 수 있는데, 기기 아이디가 고유 값이 되다 보니 서로 다른 기기에서 동시에 관심 설정을 할 경우 
관심데이터가 중복으로 적재되어 버렸다. 동시성 처리가 되지 않은 것이다.\
 해결방법은 간단하게 DB 에 사용자의 ID와 관심대상이 되는 데이터의 ID를 같이 Unique 로 걸어 데이터가 중복 처리가 되지 않도록 처리해주었다.
물론 해당 DB의 경우 한 사용자가 중복된 데이터만 갖지 않으면 됐기 때문에 간단하게 처리할 수 있었다.

## 동시성 문제?
동시성 문제란, 하나의 데이터에 2개 이상의 스레드가 접근하여 처리하면서 발생하는 문제이다. 이런 문제는 DB에서 데이터 처리시 많이 발생한다.
예를 들어 한 사람이 데이터를 수정후 저장하였는데, 막상 조회하니 다른 결과가 나오는 경우이다. 가장 와닿는 예시는 아마도 결제관련 예시일 것이다.\
재고가 딱 1개 남은 어떤 물건을 사려고 결제창에서 결제를 할 때, 결제가 정상 처리 된 후 구매 내역을 봤더니 구매한 물건이 없는.. 즉 돈은
돈대로 나가고 물건은 받지 못하는 상황이 발생한다. 이런 문제를 예방하기 위해선 동시성 문제를 항상 고민해주어야 한다.

## 동시성 처리를 하는 방법?
동시성 처리는 보통 아래와 같은 방법으로 막아볼 수 있다.
* 하나의 row에 대해 접근 시 lock을 걸어버려 다른 스레드가 접근하지 못하게 막고, 다른 lock들이 걸려있지 않을 때 데이터를 수정할 수 있게 한다.
* 하나의 row에 대해 수정할 때 현재 접근한 스레드가 수정했다는 표시를 남기고, 다른 스레드가 동일 조건으로 값을 수정할 수 없도록 한다.

첫번째는 비관적 락, 두번째는 낙관적 락이다.

### 비관적 락
비관적 락은 '동시성 문제가 무조건 발생할 거야!' 라는 것을 예상하고 락을 걸어버리는 방법이다.\
수정할 데이터에 row-level lock을 걸어버린다. 이렇게 되면 lock이 걸려있는 동안 다른 요청들은 해당 데이터를 수정할 수 없게 된다. 이렇게 되면 데이터의
무결성을 완벽하게 보장할 수 있다.\
대신 단점은 해당 로우 자체에 락이 걸리기 때문에 해당 데이터의 작업이 완료될 동안 다른 요청들은 해당 데이터에 접근할 수 없게 된다. 
# SNS를 통한 로그인 구현

이번 개발 진행 중 SNS 계정을 통해 회원 가입 및 로그인을 할 수 있도록 하는 기능을 개발 하게 되었다. 이를 위해 개발 전에 SNS를 통한 로그인 기능이 어떻게\
동작 하는지, 그리고 해당 기능을 구현하려면 어떻게 해야 하는지에 대해 간단하게 정리하는 내용을 작성해본다.

이번에 로그인에 사용할 SNS는 총 3가지를 사용한다. 카카오, 네이버, 구글 아이디를 통해 로그인 및 회원가입 처리를 할 수 있도록 개발할 예정이다. 각 서비스\
마다 로그인 방식이 조금씩 다르기 때문에 각각의 API 를 확인하여 로그인 기능을 구현해야 한다. 각 기능에 대해 정리해보기 전에 SNS 로그인이 어떻게 이루어 지는지\
간단하게 정리해본다.

### SNS 로그인 방식

일단 SNS 로그인에는 client, resource owner, resource server 3가지에 대해 알아야 한다. 간단하게 설명하자면\
**client = 우리 서비스**\
**resource owner = 사용자**\
**resource server = SNS 서버**\
라고 생각하면 된다. 연동 순서는 일단 네이버와 카카오 연동 기준으로 작성해본다.

1. resource owner(이하 RO) 가 client 에 SNS 로그인 버튼을 클릭한다.
2. client 는 resource server(이하 RS) 에 로그인 할 수 있는 URL 을 호출한다.
3. 각 RS 별 사용자 인증을 거쳐 client 에 제공해 줄 정보들에 대한 동의를 RO 에게 얻는다.
4. 모든 동의를 얻으면 RS는 access token 을 얻을 수 있는 코드를 client 에 리턴해준다.
5. client 는 해당 코드를 이용하여 access token 을 획득한다.
6. client 는 획득한 access token 을 이용 하여 사용자 정보를 조회한다.
7. 만일 사용자가 client 에 가입한 사용자면 로그인을, 가입하지 않았다면 client 의 회원가입 처리를 진행한다.

연동 순서를 유심히 보면 RO는 client 에 가입 혹은 로그인을 진행하긴 하지만 아이디와 패스워드를 별도로 client 에 입력하는 과정은 존재하지 않는다.\
단지 소셜에 로그인 버튼을 클릭하여 로그인과 회원가입 모두를 진행한다. 위와 같이 네이버나 카카오는 client 와 RO 사이에서 로그인을 중개해주는 역할을 한다.\
이렇게 중개자의 역할을 해주는 서비스가 바로 **OAuth** 다. RO 가 로그인을 하면 RS 는 client 에게 RO 의 아이디와 비밀번호를 넘겨주지 않고,\
사용자 정보를 얻을 수 있는 access token 을 제공해준다. client는 이 토큰을 이용하여 RS로 부터 사용자 정보를 제공 받을 수 있게 되는 것이다.


###9월 2일 
SNS 로그인 작업을 하면서 서칭 및 알게된 점들에 대해 간단히 정리해본다. 일단 카카오 기준으로 작성해보자면, 카카오의 경우 로그인 할 수 있는 
메소드를 2개 제공한다. 하나는 auth.login 이고 다른 하나는 auth.authorize 메소드이다. 둘의 차이는 아래와 같다.
#### auth.login
- 팝업 방식
- 별도의 리다이렉트 URL 이 필요없음

#### auth.authorize
- redirection 방식
- 리다이렉트 할 수 있는 URL이 명시되어야 함.

이번 개발에서 적용한 방식은 auth.login 방식을 적용했는데, 현재 개발하는 프로그램에 Capacitor를 이용한 웹뷰 형식의 하이브리드 앱이다. 
처음에는 authorize 메소드를 이용하여 개발을 진행하려 했는데, 그 이유는 authorize 메소드가 리다이렉트 방식을 사용하기 때문에 로그인 시
별도의 팝업 없이 로그인 절차를 진행하게 된다. login 메소드는 팝업 형식이라 하이브리드 앱에서 동작 시키기 위해선 User-Agent 값을 
변경시켜주어야 한다. 또한 팝업 동작 시 window.open과 window.close 메소드를 오버라이드 하여 실제 앱을 실행할 수 있게 구현해주어야 한다.
생각보다 처리해주어야 할게 많다는 이야기이다.

그래서 authorize를 이용하여 프론트에서는 리다이렉트 URL을 통해 access_token을 얻을수 있는 인가코드를 서버에 보낼 수 있게 
리다이렉트 URL과 가입 시 정보제공에 대한 동의 값들을 설정하여 호출 할 수 있게 구현해놓았다. 당연 서버단에서는 리다이렉트 URL에서 
받아온 인가코드로 access_token을 얻은 후 해당 토큰으로 사용자 정보를 조회할 수 있게 구현하였다. 즉 순서를 정리하자면
1. 프론트에서 설정한 리다이렉트 URL로 인가코드를 넘겨줌(Get 방식, query param으로 넘어옴.)
2. 서버단의 리다이렉트 URL로 넘어온 인가코드를 이용해 사용자에 대한 access_token을 얻을수 있는 API를 호출해줌.
3. 호출 후 access_token 을 얻어왔으면 해당 토큰으로 사용자 정보를 얻을 수 있는 API를 또 한번 호출해줌 (Bearer token)
4. 얻어온 사용자 정보로 로그인, 혹은 회원가입을 진행해준다.

위 방식대로 구현을 한 후 테스트 해보니 정상적으로 사용자 정보를 가져오는 걸 확인할 수 있었다. 그러나 여기서 문제가 발생했는데... 
사용자 동의를 구하고 다음 단계로 넘어가면 위에서 설정한 리다이렉트 URL로 인가코드를 전달해준다. 그러면서 동시에 해당 URL로 페이지가
리다이렉트 되는데, 우리는 서버와 프론트가 분리되어 있다보니 리다이렉트 URL로 페이지가 넘어가면 다시 웹으로 돌아갈 수가 없었다.
서버단의 URL을 호출하다 보니 아예 서버단 주소로 넘어가버리는 것이다... 

 그렇다면 리다이렉트 URL 주소를 프론트 내의 다른 페이지로 넘겨주면 되지 않을까? 했지만... 현재 개발하고 있는 프로그램은
**웹뷰 형식의 하이브리드 앱**이다 앱에 올리면 호출할 URL이 없는 것이다. 설상 가상 리다이렉트를 해주려면 카카오 개발자 페이지에도 
리다이렉트 할 URL 을 명시해주지 않으면 리다이렉트가 되지 않는다. 즉, 인가코드를 넘기고 나면 다시 원래 페이지 혹은 넘어가고싶은 페이지로
넘어갈수 없게 되는 것이다... 그래서 하루동안 열심히 찾아봤지만 결국 해답을 얻지 못한채로 login 방식을 사용하기로 하고 다시 구글링에 들어갔다.

login 방식에 대해 이것 저것 찾아 본 결과, 결국은 네이티브를 건드릴 수 밖에 없어보였다. 하지만 이번 프로젝트는 아이폰과 안드로이드 모두
배포하는 형식이라 안드로이드 내에서만 따로 코드 작성을 하기엔 제약사항이 생겨 그렇게 할 수 없었다. 그러다 발견한 것이 캐퍼시터 내에서
안드로이드 아이폰 상관없이 로그인 기능을 제공해주는 모듈을 발견하여 해당 모듈을 사용하였다. 직접 구현해야하는 번거로음을 많이 덜게 되었다...